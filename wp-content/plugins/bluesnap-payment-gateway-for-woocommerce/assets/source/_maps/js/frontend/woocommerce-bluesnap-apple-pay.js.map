{"version":3,"names":[],"mappings":"","sources":["frontend/woocommerce-bluesnap-apple-pay.js"],"sourcesContent":["(function( $ ) {\n\n\tvar wc_bluesnap_payment_request = {\n\t\ttype: 'apple_pay',\n\t\tinitialized: false,\n\t\tsession: null, \n\t\tinit: function(){\n\t\t\tif( wc_bluesnap_payment_request.initialized ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif ( typeof window.ApplePaySession === 'undefined' ) {\n\t\t\t\t// Device doesn't support Apple Pay\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar cartOrCheckout = $( 'form.woocommerce-cart-form, form.checkout' );\n\t\t\tif( ! cartOrCheckout.length ) {\n\t\t\t\t// not in cart or checkout\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twc_bluesnap_payment_request.initialized = true;\n\n\t\t\tif( 0 == woocommerce_bluesnap_apple_pay_params.cart_compatible_apple_pay ) {\n\t\t\t\twc_bluesnap_payment_request.showError( '<div class=\"woocommerce-info\">' + woocommerce_bluesnap_apple_pay_params.i18n.apple_pay.not_compatible_with_cart + '</div>' );\n\t\t\t\treturn;\n\t\t\t} \n\t\t\t\n\t\t\tif ( ! wc_bluesnap_payment_request.cartCanWorkWithApplePay() ) {\n\t\t\t\twc_bluesnap_payment_request.showError( '<div class=\"woocommerce-info\">' + woocommerce_bluesnap_apple_pay_params.i18n.apple_pay.device_not_compat_with_cart + '</div>' );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (ApplePaySession.canMakePayments() ) {\n\t\t\t\t$('<style></style>')\n\t\t\t\t\t.attr('id', 'wc-bluesnap-apple-pay-css')\n\t\t\t\t\t.html('#wc-bluesnap-apple-pay-wrapper, #wc-bluesnap-apple-pay-button-separator { display: block !important; }')\n\t\t\t\t\t.appendTo('body');\n\n\t\t\t\t$(document).on('click', '#wc-bluesnap-apple-pay-wrapper a.apple-pay-button', wc_bluesnap_payment_request.applePayClicked );\n\t\t\t} else {\n\t\t\t\twc_bluesnap_payment_request.showError( '<div class=\"woocommerce-info\">' + woocommerce_bluesnap_apple_pay_params.i18n.apple_pay.not_able_to_make_payments + '</div>' );\n\t\t\t}\n\t\t},\n\t\tcartCanWorkWithApplePay: function(e) {\n\t\t\treturn window.ApplePaySession !== undefined && ApplePaySession.supportsVersion( parseInt( woocommerce_bluesnap_apple_pay_params.version_required ) );\n\t\t},\n\t\tapplePayClicked: function(e) {\n\t\t\te.preventDefault();\n\t\t\tif( wc_bluesnap_payment_request.session !== null ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twc_bluesnap_payment_request.blockForm();\n\n\t\t\twc_bluesnap_payment_request.type = 'apple_pay';\n\t\t\twc_bluesnap_payment_request.getRequestData().then(function(request){\n\t\t\t\tvar apple_session = wc_bluesnap_payment_request.session = new ApplePaySession( woocommerce_bluesnap_apple_pay_params.version_required, request );\n\n\t\t\t\tapple_session.onvalidatemerchant = wc_bluesnap_payment_request.applePayValidateMerchant;\n\n\t\t\t\tapple_session.onshippingcontactselected = wc_bluesnap_payment_request.applePayUpdateShippingInfo;\n\n\t\t\t\tapple_session.onshippingmethodselected = wc_bluesnap_payment_request.applePayUpdateShippingMethod;\n\n\t\t\t\tapple_session.onpaymentauthorized = wc_bluesnap_payment_request.applePayPaymentAuthorized;\n\n\t\t\t\tapple_session.oncancel = wc_bluesnap_payment_request.handleCancel;\n\n\t\t\t\tapple_session.begin();\n\t\t\t}, function() {\n\t\t\t\talert('Apple Pay could not be initialized. Try an alternate form of payment');\n\t\t\t});\n\t\t},\n\t\tapplePayValidateMerchant: function (event) {\n\t\t\t$.ajax(\n\t\t\t\t{\n\t\t\t\t\turl: wc_bluesnap_payment_request.getAjaxUrl('create_apple_wallet'),\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tdataType: 'json',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsecurity: woocommerce_bluesnap_apple_pay_params.nonces.create_apple_wallet,\n\t\t\t\t\t\tvalidation_url: event.validationURL,\n\t\t\t\t\t\tpayment_request_type: wc_bluesnap_payment_request.type\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t).then(\n\t\t\t\tfunction ( res ) {\n\t\t\t\t\tif( ! res.success ) {\n\t\t\t\t\t\twc_bluesnap_payment_request.handleError( res );\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tvar decoded_token = window.atob( res.data.walletToken );\n\t\t\t\t\twc_bluesnap_payment_request.session.completeMerchantValidation( JSON.parse( decoded_token ) );\n\t\t\t\t}, wc_bluesnap_payment_request.handleError\n\t\t\t);\n\t\t},\n\t\tapplePayUpdateShippingInfo: function( event ) {\n\t\t\tvar address = event.shippingContact;\n\n\t\t\t$.ajax(\n\t\t\t\t{\n\t\t\t\t\turl: wc_bluesnap_payment_request.getAjaxUrl('get_shipping_options'),\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tdataType: 'json',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsecurity: woocommerce_bluesnap_apple_pay_params.nonces.get_shipping_options,\n\t\t\t\t\t\taddress:   window.btoa( JSON.stringify( address ) ),\n\t\t\t\t\t\tpayment_request_type: wc_bluesnap_payment_request.type\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t).then(\n\t\t\t\tfunction ( res ) {\n\t\t\t\t\tvar data = res.data;\n\t\t\t\t\tif( ! res.success ) {\n\t\t\t\t\t\tvar err = new ApplePayError(\"shippingContactInvalid\", \"postalAddress\", data.message);\n\t\t\t\t\t\twc_bluesnap_payment_request.session.completeShippingContactSelection({\n\t\t\t\t\t\t\tstatus: ApplePaySession.STATUS_FAILURE,\n\t\t\t\t\t\t\terrors: [ err ],\n\t\t\t\t\t\t\tnewShippingMethods: [],\n\t\t\t\t\t\t\tnewLineItems: data.lineItems,\n\t\t\t\t\t\t\tnewTotal: data.total\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\twc_bluesnap_payment_request.session.completeShippingContactSelection({\n\t\t\t\t\t\tstatus: ApplePaySession.STATUS_SUCCESS,\n\t\t\t\t\t\tnewShippingMethods: data.shippingMethods,\n\t\t\t\t\t\tnewLineItems: data.lineItems,\n\t\t\t\t\t\tnewTotal: data.total\n\t\t\t\t\t});\n\t\t\t\t}, wc_bluesnap_payment_request.handleError\n\t\t\t);\n\t\t},\n\t\tapplePayUpdateShippingMethod: function( event ) {\n\t\t\tvar method = event.shippingMethod;\n\n\t\t\t$.ajax(\n\t\t\t\t{\n\t\t\t\t\turl: wc_bluesnap_payment_request.getAjaxUrl('update_shipping_method'),\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tdataType: 'json',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsecurity: woocommerce_bluesnap_apple_pay_params.nonces.update_shipping_method,\n\t\t\t\t\t\tmethod:   [ method.identifier ],\n\t\t\t\t\t\tpayment_request_type: wc_bluesnap_payment_request.type\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t).then(\n\t\t\t\tfunction ( res ) {\n\t\t\t\t\tvar data = res.data;\n\t\t\t\t\tif( ! res.success ) {\n\t\t\t\t\t\twc_bluesnap_payment_request.session.completeShippingMethodSelection({\n\t\t\t\t\t\t\tstatus: ApplePaySession.STATUS_FAILURE,\n\t\t\t\t\t\t\tnewLineItems: data.lineItems,\n\t\t\t\t\t\t\tnewTotal: data.total\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\twc_bluesnap_payment_request.session.completeShippingMethodSelection({\n\t\t\t\t\t\tstatus: ApplePaySession.STATUS_SUCCESS,\n\t\t\t\t\t\tnewLineItems: data.lineItems,\n\t\t\t\t\t\tnewTotal: data.total\n\t\t\t\t\t});\n\t\t\t\t}, wc_bluesnap_payment_request.handleError\n\t\t\t);\n\t\t},\n\t\tapplePayPaymentAuthorized: function (event) {\n\t\t\tvar paymentToken = event.payment;\n\t\t\t//https://developers.bluesnap.com/docs/apple-pay#section-step-5-set-up-the-onpaymentauthorized-callback\n\t\t\t$.ajax(\n\t\t\t\t{\n\t\t\t\t\turl: wc_bluesnap_payment_request.getAjaxUrl('create_apple_payment'),\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tdataType: 'json',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\t_wpnonce: woocommerce_bluesnap_apple_pay_params.nonces.checkout,\n\t\t\t\t\t\tpayment_token: window.btoa( JSON.stringify( paymentToken ) ),\n\t\t\t\t\t\tpayment_request_type: wc_bluesnap_payment_request.type\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t).then(\n\t\t\t\tfunction (res) {\n\t\t\t\t\tif( typeof res.success !== 'undefined' && false === res.success ) {\n\t\t\t\t\t\twc_bluesnap_payment_request.handleError( res );\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif( typeof res.result !== 'undefined' ) {\n\t\t\t\t\t\twc_bluesnap_payment_request.handleWCResponse( res );\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconsole.log( res );\n\t\t\t\t}, wc_bluesnap_payment_request.handleError\n\t\t\t);\n\t\t},\n\t\tgetAjaxUrl: function(method) {\n\t\t\treturn woocommerce_bluesnap_apple_pay_params.wc_ajax_url.toString().replace( '%%endpoint%%', 'bluesnap_' + method )\n\t\t},\n\t\tgetRequestData: function() {\n\t\t\tvar ret = $.Deferred();\n\t\t\t$.ajax(\n\t\t\t\t{\n\t\t\t\t\turl: wc_bluesnap_payment_request.getAjaxUrl('get_payment_request'),\n\t\t\t\t\tmethod: \"POST\",\n\t\t\t\t\tdataType: 'json',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsecurity: woocommerce_bluesnap_apple_pay_params.nonces.get_payment_request,\n\t\t\t\t\t\tpayment_request_type: wc_bluesnap_payment_request.type\n\t\t\t\t\t},\n\t\t\t\t\tasync: false\n\t\t\t\t}\n\t\t\t).done( function( res ) {\n\t\t\t\tif( res.success ) {\n\t\t\t\t\tret.resolve( res.data )\n\t\t\t\t} else {\n\t\t\t\t\tret.reject();\n\t\t\t\t}\n\t\t\t}).fail(function() {\n\t\t\t\tret.reject();\n\t\t\t});\n\t\t\treturn ret.promise();\n\t\t},\n\t\thandleError: function(error) {\n\t\t\tswitch( wc_bluesnap_payment_request.type ) {\n\t\t\t\tcase 'apple_pay':\n\t\t\t\t\twc_bluesnap_payment_request.session.completePayment( ApplePaySession.STATUS_FAILURE );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\twc_bluesnap_payment_request.session = null;\n\t\t\twc_bluesnap_payment_request.unblockForm();\n\t\t\t$( document.body ).trigger( 'update_checkout' );\n\t\t},\n\t\thandleSuccess: function() {\n\t\t\tswitch( wc_bluesnap_payment_request.type ) {\n\t\t\t\tcase 'apple_pay':\n\t\t\t\t\twc_bluesnap_payment_request.session.completePayment( ApplePaySession.STATUS_SUCCESS );\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\twc_bluesnap_payment_request.session = null;\n\t\t},\n\t\thandleCancel: function() {\n\t\t\tswitch( wc_bluesnap_payment_request.type ) {\n\t\t\t\tcase 'apple_pay':\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\twc_bluesnap_payment_request.session = null;\n\t\t\twc_bluesnap_payment_request.unblockForm();\n\t\t\t$( document.body ).trigger( 'update_checkout' );\n\t\t},\n\t\thandleWCResponse: function(result) {\n\t\t\ttry {\n\t\t\t\tif ( 'success' === result.result ) {\n\t\t\t\t\twc_bluesnap_payment_request.handleSuccess();\n\n\t\t\t\t\tif ( -1 === result.redirect.indexOf( 'https://' ) || -1 === result.redirect.indexOf( 'http://' ) ) {\n\t\t\t\t\t\twindow.location = result.redirect;\n\t\t\t\t\t} else {\n\t\t\t\t\t\twindow.location = decodeURI( result.redirect );\n\t\t\t\t\t}\n\t\t\t\t} else if ( 'failure' === result.result ) {\n\t\t\t\t\tthrow 'Result failure';\n\t\t\t\t} else {\n\t\t\t\t\tthrow 'Invalid response';\n\t\t\t\t}\n\t\t\t} catch( err ) {\n\t\t\t\t// Reload page\n\t\t\t\tif ( true === result.reload ) {\n\t\t\t\t\twindow.location.reload();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Trigger update in case we need a fresh nonce\n\t\t\t\tif ( true === result.refresh ) {\n\t\t\t\t\t$( document.body ).trigger( 'update_checkout' );\n\t\t\t\t}\n\n\t\t\t\t// Add new errors\n\t\t\t\tif ( result.messages ) {\n\t\t\t\t\twc_bluesnap_payment_request.showError( result.messages );\n\t\t\t\t} else {\n\t\t\t\t\twc_bluesnap_payment_request.showError( '<div class=\"woocommerce-error\">' + woocommerce_bluesnap_apple_pay_params.i18n.checkout_error + '</div>' );\n\t\t\t\t}\n\n\n\t\t\t}\n\t\t},\n\t\tgetForm: function() {\n\t\t\tvar form = $( 'form.woocommerce-checkout' );\n\t\t\tif( ! form.length ) {\n\t\t\t\tform = $( 'form#add_payment_method' );\n\t\t\t}\n\t\t\tif( ! form.length ) {\n\t\t\t\tform = $( 'form#order_review' );\n\t\t\t}\n\t\t\tif( ! form.length ) {\n\t\t\t\tform = $( 'form.woocommerce-cart-form' );\n\t\t\t\tif( form.length ) {\n\t\t\t\t\tform = form.closest(\".woocommerce\");\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn form;\n\t\t},\n\t\tblockForm: function() {\n\t\t\twc_bluesnap_payment_request.getForm().addClass('processing').block( {\n\t\t\t\tmessage: null,\n\t\t\t\toverlayCSS: {\n\t\t\t\t\tbackground: '#fff',\n\t\t\t\t\topacity: 0.6\n\t\t\t\t}\n\t\t\t} );\n\t\t},\n\t\tunblockForm: function() {\n\t\t\twc_bluesnap_payment_request.getForm().removeClass( 'processing' ).unblock();\n\t\t},\n\t\tshowError: function( error_message ) {\n\t\t\tvar form = wc_bluesnap_payment_request.getForm();\n\t\t\tif( ! form.length ) {\n\t\t\t\tconsole.error( error_message );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$( '.woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message' ).remove();\n\t\t\tform.prepend( '<div class=\"woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout\">' + error_message + '</div>' );\n\t\t\twc_bluesnap_payment_request.unblockForm();\n\t\t\t\n\t\t\tvar scroll_element = $( '.woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout' );\n\t\t\tif ( ! scroll_element.length ) {\n\t\t\t\tscroll_element = $( form );\n\t\t\t}\n\t\t\t$.scroll_to_notices( scroll_element );\n\n\t\t\t$( document.body ).trigger( 'checkout_error' );\n\t\t}\n\t}\n\n\t// On Checkout form.\n\t$( document.body ).on(\n\t\t'updated_checkout', function() {\n\t\t\twc_bluesnap_payment_request.init();\n\t\t}\n\t);\n\n\t$(wc_bluesnap_payment_request.init); // on ready\n\n})( jQuery );\n"],"file":"../../../../js/frontend/woocommerce-bluesnap-apple-pay.js"}